# Обновление пакетов
sudo apt update
sudo apt upgrade -y

# Установка MySQL сервера
sudo apt install mysql-server -y

# Запуск и включение автозапуска
sudo systemctl start mysql
sudo systemctl enable mysql

# Проверка статуса
sudo systemctl status mysql

# Запуск скрипта безопасности
sudo mysql_secure_installation

# Вход в MySQL как root
sudo mysql -u root -p

-- Переключение на использование пароля
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'RootPassword123!';

-- Обновление привилегий
FLUSH PRIVILEGES;

-- Выход
EXIT;

# Выполнение скрипта от имени root
sudo mysql -u root -p < init_database.sql


# Обновление пакетов
sudo apt update

# Установка зависимостей
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

# Добавление официального GPG ключа Docker
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# Добавление репозитория Docker
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Установка Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# Добавление пользователя в группу docker
sudo usermod -aG docker $USER

# Перезагрузка для применения изменений
newgrp docker

docker pull python:3.9-slim

# Используем официальный образ Python
FROM python:3.9-slim

# Устанавливаем рабочую директорию
WORKDIR /app

# Копируем файл зависимостей
COPY requirements.txt .

# Устанавливаем зависимости
RUN pip install --no-cache-dir -r requirements.txt

# Копируем исходный код приложения
COPY . .

# Создаем директорию для логов
RUN mkdir -p /app/logs

# Открываем порт
EXPOSE 5000

# Запускаем приложение
CMD ["python", "app.py"]

Flask==2.3.3
mysql-connector-python==8.1.0
Werkzeug==2.3.7

# Сборка образа
docker build -t campusspace-app .

# Запуск контейнера
docker run -d -p 5000:5000 --name campusspace-container campusspace-app

# Проверка запущенных контейнеров
docker ps

# Просмотр логов
docker logs campusspace-container

# Скачивание docker-compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# Установка прав на выполнение
sudo chmod +x /usr/local/bin/docker-compose

# Проверка установки
docker-compose --version

version: '3.8'

services:
  # MySQL база данных
  mysql:
    image: mysql:8.0
    container_name: campusspace-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: classroom-fund
      MYSQL_USER: campususer
      MYSQL_PASSWORD: campuspass
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init_database.sql:/docker-entrypoint-initdb.d/init_database.sql
      - ./mysql_logs:/var/log/mysql
    networks:
      - campusspace-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # Flask приложение
  web:
    build: .
    container_name: campusspace-web
    ports:
      - "5000:5000"
    environment:
      - DATABASE_HOST=mysql
      - DATABASE_USER=campususer
      - DATABASE_PASSWORD=campuspass
      - DATABASE_NAME=classroom-fund
    volumes:
      - ./app_logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - campusspace-network
    restart: unless-stopped

volumes:
  mysql_data:

networks:
  campusspace-network:
    driver: bridge

  FROM python:3.9-slim

WORKDIR /app

# Установка системных зависимостей для mysql-connector
RUN apt-get update && apt-get install -y \
    default-libmysqlclient-dev \
    build-essential \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .

RUN pip install --no-cache-dir -r requirements.txt

COPY . .

RUN mkdir -p /app/logs /app/uploads

EXPOSE 5000

CMD ["python", "app.py"]

# Запуск всех сервисов
docker-compose up -d

# Проверка статуса
docker-compose ps

# Просмотр логов
docker-compose logs -f

# Остановка сервисов
docker-compose down

docker-compose up -d

# Остановите приложение
docker-compose down

# Запустите снова
docker-compose up -d

# Проверка данных БД
docker volume ls

# Просмотр логов
ls -la ./app_logs/

# Проверка файлов БД
docker exec -it campusspace-mysql bash -c "ls -la /var/lib/mysql/classroom-fund/"

# Проверка подключения к БД
docker exec -it campusspace-mysql mysql -u campususer -pcampuspass classroom-fund -e "SHOW TABLES;"

# Просмотр данных пользователей
docker exec -it campusspace-mysql mysql -u campususer -pcampuspass classroom-fund -e "SELECT * FROM users;"

# Просмотр логов приложения
tail -f ./app_logs/app.log